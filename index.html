<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock & Template Manager</title>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4F46E5;
            --primary-hover: #4338ca;
            --secondary: #10B981;
            --bg-color: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --border-color: #E5E7EB;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        header {
            text-align: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 20px;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            margin: 0 0 10px 0;
        }

        p.subtitle {
            color: var(--text-muted);
            margin: 0;
        }

        .steps-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .step-card {
            background: #F9FAFB;
            border: 2px dashed #D1D5DB;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.2s ease;
            position: relative;
        }

        .step-card:hover {
            border-color: var(--primary);
            background: #F0F9FF;
        }

        .step-card.active {
            border-color: var(--secondary);
            background: #ECFDF5;
        }

        .step-title {
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 12px;
            font-size: 16px;
        }

        input[type="file"] {
            display: none;
        }

        .custom-file-upload {
            display: inline-block;
            padding: 10px 20px;
            cursor: pointer;
            background: white;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s;
        }

        .custom-file-upload:hover {
            background: #F3F4F6;
        }

        .file-name {
            margin-top: 10px;
            font-size: 13px;
            color: var(--primary);
            font-weight: 500;
            word-break: break-all;
        }

        /* Preview Area */
        .preview-section {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            height: 350px;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .search-box {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 250px;
            font-size: 14px;
        }

        .table-wrapper {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: #F8F9FB;
            color: #4B5563;
            font-weight: 600;
            padding: 10px 14px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 10px 14px;
            border-bottom: 1px solid #E5E7EB;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .action-area {
            text-align: center;
            margin-top: 10px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }

        .btn-primary:disabled {
            background-color: #9CA3AF;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-secondary {
            background-color: white;
            color: var(--primary);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary:hover {
            background-color: #F3F4F6;
            border-color: var(--primary);
        }

        .status-msg {
            margin-top: 15px;
            font-size: 14px;
            color: var(--text-muted);
            min-height: 20px;
        }

        .warning-banner {
            background-color: #FEF2F2;
            border: 1px solid #FCA5A5;
            color: #991B1B;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Responsive */
        @media (max-width: 700px) {
            .steps-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>Stock Assistant Pro</h1>
            <p class="subtitle">Update your stock sheet with today's counts, highlighting changes and low stock.</p>
            <div style="margin-top: 15px;">
                <a href="./Yesterday Stocks.xlsx" download="Yesterday_Stocks_Template.xlsx" class="btn-secondary">
                    ⬇️ Download Yesterday's Stock Template
                </a>
            </div>
        </header>

        <div class="warning-banner">
            ⚠️ ALWAYS CHECK YOUR SHEET BEFORE UPLOADING
        </div>

        <div class="steps-container">
            <!-- Step 1 -->
            <div class="step-card" id="step1Card">
                <div class="step-title">1. Today's Stock Data</div>
                <label for="sourceFile" class="custom-file-upload">
                    Upload New Data (Excel)
                </label>
                <input type="file" id="sourceFile" accept=".xlsx,.xls">
                <div id="sourceFileName" class="file-name"></div>
            </div>

            <!-- Step 2 -->
            <div class="step-card" id="step2Card">
                <div class="step-title">2. Yesterday's Stock (Template)</div>
                <label for="historyFile" class="custom-file-upload">
                    Upload Previous Sheet
                </label>
                <input type="file" id="historyFile" accept=".xlsx,.xls">
                <div id="historyFileName" class="file-name"></div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="preview-section" id="previewSection" style="display:none;">
            <div class="preview-header">
                <h3 style="margin:0; font-size:16px;">Preview & Comparison</h3>
                <input type="text" id="skuSearch" class="search-box" placeholder="Search SKU...">
            </div>
            <div class="table-wrapper">
                <table id="previewTable">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Today's Stock</th>
                            <th>Yesterday's Stock</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="margin-top: 10px; font-size: 13px; color: #666;" id="recordCount"></div>
        </div>

        <div class="action-area">
            <button id="exportBtn" class="btn-primary" disabled>
                <span>Process & Update Sheet</span>
            </button>
            <div id="status" class="status-msg">Waiting for files...</div>
        </div>
    </div>

    <script>
        // State management
        let state = {
            todayData: {},    // SKU -> MaxStock
            historyData: {},  // SKU -> MaxStock
            templateBuffer: null, // Stores Yesterday's file raw buffer to use as template
            templateName: ""
        };

        const els = {
            sourceFile: document.getElementById('sourceFile'),
            historyFile: document.getElementById('historyFile'),

            sourceName: document.getElementById('sourceFileName'),
            historyName: document.getElementById('historyFileName'),

            previewSection: document.getElementById('previewSection'),
            exportBtn: document.getElementById('exportBtn'),
            status: document.getElementById('status'),
            tableBody: document.querySelector('#previewTable tbody'),
            search: document.getElementById('skuSearch'),
            count: document.getElementById('recordCount'),

            step1: document.getElementById('step1Card'),
            step2: document.getElementById('step2Card')
        };

        // --- Helper: Read and Parse Max Stock ---
        function parseStockFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (event) {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];

                        // 1. Header Detection
                        const rawRows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                        let headerRowIndex = 0;
                        let foundHeader = false;

                        for (let i = 0; i < Math.min(rawRows.length, 20); i++) {
                            const row = rawRows[i];
                            if (!row || row.length === 0) continue;
                            const rowStr = row.map(c => String(c).trim().toUpperCase());

                            const hasSku = rowStr.some(c => /SKU|PRODUCT NO|ITEM NO|CODE/.test(c));
                            const hasStock = rowStr.some(c => /AVAIL|STOCK|QTY|QUANTITY|VOLUME/.test(c));

                            if (hasSku && hasStock) { headerRowIndex = i; foundHeader = true; break; }
                            if (hasSku && !foundHeader) { headerRowIndex = i; foundHeader = true; }
                        }

                        // 2. Parse Data to JSON
                        const rows = XLSX.utils.sheet_to_json(sheet, { range: headerRowIndex, defval: "" });
                        if (rows.length === 0) { resolve({}); return; }

                        // 3. Resolve Columns
                        const headers = Object.keys(rows[0]);
                        let skuKey = headers.find(h => /sku|product|item|code/i.test(h));
                        let stockKey = headers.find(h => /availability|avail|stock|qty|quantity|volume/i.test(h));

                        // 4. Data Sniffing for main column
                        let validStockCount = 0;
                        const sampleSize = Math.min(rows.length, 5);

                        if (stockKey) {
                            for (let i = 0; i < sampleSize; i++) {
                                const val = rows[i][stockKey];
                                if (val !== undefined && val !== "" && !isNaN(parseInt(val))) validStockCount++;
                            }
                        }

                        if (validStockCount === 0) {
                            // Fallback sniff
                            for (const key of headers) {
                                if (key === skuKey) continue;
                                let numCount = 0;
                                for (let i = 0; i < sampleSize; i++) {
                                    const val = rows[i][key];
                                    if (val !== undefined && val !== "" && !isNaN(parseInt(val))) numCount++;
                                }
                                if (numCount > 0) { stockKey = key; break; }
                            }
                        }

                        // 5. Detect "Real Value" Neighbor Column (For Yesterday's File)
                        // We need to know which column index 'stockKey' corresponds to in the ORIGINAL sheet
                        // to find the "next" column.
                        // However, `sheet_to_json` gives us keys.
                        // The keys usually correspond to header names.

                        // Strategy: If value is small (<=3), check if there is a value in the 'next' property key?
                        // No, keys are unordered.
                        // Simpler: iterate `rawRows` again? No, let's use the 'Headers' array order.

                        const stockKeyIndex = headers.indexOf(stockKey);
                        let realStockKey = null;
                        if (stockKeyIndex !== -1 && stockKeyIndex + 1 < headers.length) {
                            realStockKey = headers[stockKeyIndex + 1];
                        }

                        const stockMap = {};
                        rows.forEach(row => {
                            const skuRaw = skuKey ? row[skuKey] : (row["SKU"] || row["Product No"]);
                            let stockRaw = 0;
                            if (stockKey && row[stockKey] !== undefined && row[stockKey] !== "") {
                                stockRaw = row[stockKey];
                            }

                            if (skuRaw) {
                                const sku = String(skuRaw).trim();
                                let stock = parseInt(stockRaw, 10);

                                if (!isNaN(stock)) {
                                    // SMART CHECK: If stock is low (0,1,2,3), check neighbor for "Real Stock"
                                    if (stock <= 3 && realStockKey) {
                                        const realValRaw = row[realStockKey];
                                        const realVal = parseInt(realValRaw, 10);
                                        if (!isNaN(realVal) && realVal > stock) {
                                            stock = realVal; // Use the real value found in neighbor
                                        }
                                    }

                                    if (stockMap[sku] === undefined || stock > stockMap[sku]) {
                                        stockMap[sku] = stock;
                                    }
                                }
                            }
                        });

                        resolve(stockMap);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // --- Step 1: Today's Stock ---
        els.sourceFile.addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!confirm("Are you sure to upload this? Is this up to date?")) {
                e.target.value = ""; // Clear selection
                return;
            }

            els.sourceName.textContent = file.name;
            els.step1.classList.add('active');
            els.status.textContent = "Processing new data...";

            try {
                state.todayData = await parseStockFile(file);
                els.status.textContent = `Loaded ${Object.keys(state.todayData).length} SKUs from today.`;
                renderTable();
                els.previewSection.style.display = 'flex';
                checkReady();
            } catch (err) {
                console.error(err);
                alert("Error reading file: " + err.message);
            }
        });

        // --- Step 2: Yesterday's Stock (Template) ---
        els.historyFile.addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!confirm("Are you sure to upload this? Is this up to date?")) {
                e.target.value = ""; // Clear selection
                return;
            }

            els.historyName.textContent = file.name;
            els.step2.classList.add('active');
            els.status.textContent = "Processing template...";

            state.templateName = file.name;

            const bufferReader = new FileReader();
            bufferReader.onload = async function (event) {
                state.templateBuffer = event.target.result;
                try {
                    // Parse history with improved logic
                    state.historyData = await parseStockFile(file);
                    els.status.textContent = `Loaded template & history: ${Object.keys(state.historyData).length} items.`;
                    renderTable();
                    checkReady();
                } catch (err) {
                    console.error(err);
                    alert("Error reading template file: " + err.message);
                }
            };
            bufferReader.readAsArrayBuffer(file);
        });

        // --- UI Helpers ---
        function renderTable(filter = "") {
            els.tableBody.innerHTML = "";
            const allSkus = new Set([...Object.keys(state.todayData), ...Object.keys(state.historyData)]);
            const sortedSkus = Array.from(allSkus).sort();

            let visibleCount = 0;
            const fragment = document.createDocumentFragment();

            let rendered = 0;
            for (const sku of sortedSkus) {
                if (rendered > 300) break;

                if (sku.toLowerCase().includes(filter.toLowerCase())) {
                    const tr = document.createElement("tr");
                    const today = state.todayData[sku] !== undefined ? state.todayData[sku] : "-";
                    const yday = state.historyData[sku] !== undefined ? state.historyData[sku] : "-";

                    tr.innerHTML = `<td>${sku}</td><td>${today}</td><td>${yday}</td>`;
                    fragment.appendChild(tr);
                    visibleCount++;
                    rendered++;
                }
            }

            els.tableBody.appendChild(fragment);
            els.count.textContent = `Showing top matching items`;
        }

        els.search.addEventListener('input', (e) => renderTable(e.target.value));

        function checkReady() {
            if (Object.keys(state.todayData).length > 0 && state.templateBuffer) {
                els.exportBtn.disabled = false;
            }
        }

        // --- Export Logic ---
        els.exportBtn.addEventListener('click', async () => {
            try {
                els.exportBtn.disabled = true;
                els.exportBtn.textContent = "Processing...";

                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(state.templateBuffer);
                const worksheet = workbook.getWorksheet(1);

                // 1. Locate Columns
                let skuCol = -1;
                let availCol = -1;

                // Simplified locator
                worksheet.eachRow((row, rowNumber) => {
                    if (skuCol !== -1 && availCol !== -1) return;
                    row.eachCell((cell, colNum) => {
                        const val = cell.value ? String(cell.value).trim().toUpperCase() : "";
                        if (val.includes("SKU") || val.includes("PRODUCT")) skuCol = colNum;
                        if (val.includes("AVAIL") || val.includes("STOCK") || val.includes("QTY") || val.includes("VOLUME")) availCol = colNum;
                    });
                });

                if (skuCol === -1 || availCol === -1) {
                    // Last ditch effort: assume col 1 and 3? No, unsafe. 
                    // Try sniffing for numbers if no header found?
                    // For now, require header.
                    throw new Error("Could not find 'SKU' or 'Availability' columns.");
                }

                // 2. Process Rows
                worksheet.eachRow((row, rowNumber) => {
                    const skuCell = row.getCell(skuCol);
                    const skuVal = skuCell.value ? String(skuCell.value).trim() : null;
                    if (skuVal && state.todayData[skuVal] !== undefined) {
                        const todayStock = state.todayData[skuVal];
                        const yesterdayStock = state.historyData[skuVal] !== undefined ? state.historyData[skuVal] : -1;

                        // Define Cells: B for Real Stock placeholder, availCol for Availability
                        const colBCell = row.getCell(2); // Column B is index 2
                        const availCell = row.getCell(availCol); // Column C (or wherever header found)

                        // Initialize values
                        let valForB = null;        // Value for Column B
                        let colorForB = null;      // Color for Column B

                        let valForAvail = null;    // Value for Availability Column
                        let colorForAvail = null;  // Color for Availability Column

                        // --- LOGIC ---
                        if (todayStock <= 10) {
                            // A. Low Stock (10-7 Law) -> SWAP requested
                            // "put the real value in Availability ( C coloumn) and highlight that in yellow."
                            // "add the suggested value in Coloumn B."

                            let codeValue = "";
                            let codeColor = "";

                            if (todayStock === 10) { codeValue = 3; codeColor = 'FFFFFF00'; }      // Yellow
                            else if (todayStock === 9) { codeValue = 2; codeColor = 'FFFFFF00'; }  // Yellow
                            else if (todayStock === 8) { codeValue = 1; codeColor = 'FFFFFF00'; }  // Yellow
                            else if (todayStock <= 7) { codeValue = 0; codeColor = 'FFFF0000'; }   // Red

                            valForB = codeValue;       // Col B gets the Code
                            colorForB = null;          // Col B "Highlight only Availability" -> No color for B

                            valForAvail = todayStock;  // Avail Col gets Real Value
                            colorForAvail = codeColor; // Highlighted

                        } else {
                            // B. High Stock (> 10)
                            // "If any SKU don't need the 10-7 law. Don't add anything to avalibility part."

                            valForB = todayStock; // Col B gets Real Value

                            // Check for Increase
                            if (yesterdayStock !== -1 && todayStock > yesterdayStock) {
                                // "highlight in green and put on the same B coloumn... Highlight that in green"
                                colorForB = 'FF90EE90'; // Light Green
                            }

                            // Avail Col stays empty
                            valForAvail = null;
                            colorForAvail = null;
                        }

                        // --- WRITE TO CELLS ---

                        // Column B
                        colBCell.value = valForB;
                        if (colorForB) {
                            colBCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colorForB } };
                        } else {
                            colBCell.fill = null;
                        }
                        colBCell.border = null;

                        // Availability Column
                        if (valForAvail !== null) {
                            availCell.value = valForAvail;
                            if (colorForAvail) {
                                availCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colorForAvail } };
                            } else {
                                availCell.fill = null;
                            }
                        } else {
                            availCell.value = null;
                            availCell.fill = null;
                        }
                        availCell.border = null;

                        // Clear the neighbor cell (old real value cell from previous logic) to be safe
                        if (availCol + 1 !== 2) {
                            const oldNeighbor = row.getCell(availCol + 1);
                            oldNeighbor.value = null;
                            oldNeighbor.fill = null;
                            oldNeighbor.border = null;
                        }
                    }
                });

                // Download
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                saveAs(blob, "Updated_" + state.templateName);

                els.status.textContent = "Download complete!";
                els.exportBtn.disabled = false;
                els.exportBtn.textContent = "Download Sheet";

                setTimeout(() => { els.exportBtn.textContent = "Process & Update Sheet"; }, 4000);

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                els.exportBtn.disabled = false;
            }
        });

    </script>

</body>

</html>