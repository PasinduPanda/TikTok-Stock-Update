<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced SKU Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f2f5; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .upload-section { display: flex; gap: 20px; margin-bottom: 30px; }
        .file-card { flex: 1; background: #fafafa; padding: 20px; border: 2px dashed #ddd; border-radius: 10px; text-align: center; }
        
        /* Large Preview Area */
        #previewArea { margin-top: 20px; border-top: 2px solid #eee; padding-top: 20px; }
        .search-container { margin-bottom: 15px; }
        #skuSearch { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        
        .table-wrap { height: 500px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; background: white; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #007bff; color: white; position: sticky; top: 0; padding: 15px; text-align: left; z-index: 10; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; font-family: monospace; font-size: 1.1em; }
        tr:nth-child(even) { background: #f9f9f9; }
        tr:hover { background: #edf2ff; }

        .btn-export { background: #28a745; color: white; border: none; padding: 18px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 18px; font-weight: bold; margin-top: 20px; }
        .btn-export:disabled { background: #ccc; cursor: not-allowed; }
        
        .stock-val { font-weight: bold; color: #2c3e50; }
        #status { margin-top: 10px; text-align: center; font-weight: bold; color: #555; }
    </style>
</head>
<body>

<div class="container">
    <h2>Inventory Stock Controller</h2>

    <div class="upload-section">
        <div class="file-card">
            <strong>1. Master Data (Source)</strong><br><br>
            <input type="file" id="sourceFile" accept=".xlsx,.xls">
        </div>
        <div class="file-card">
            <strong>2. Target Template</strong><br><br>
            <input type="file" id="targetFile" accept=".xlsx,.xls">
        </div>
    </div>

    <div id="previewArea" style="display:none;">
        <div class="search-container">
            <input type="text" id="skuSearch" placeholder="ðŸ” Search by SKU name...">
        </div>
        <div class="table-wrap">
            <table id="previewTable">
                <thead>
                    <tr>
                        <th>SKU Name</th>
                        <th>Maximum Real Stock Found</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="resultCount" style="margin-top:10px; font-size: 0.9em; color: #666;"></div>
    </div>

    <button id="exportBtn" class="btn-export" disabled>Apply Rules & Export Styled Excel</button>
    <div id="status">Waiting for Master Data...</div>
</div>

<script>
    let sourceDataMax = {};
    let targetFileArrayBuffer = null;
    let targetFileName = "";

    // 1. Load Source and Create Preview
    document.getElementById('sourceFile').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            sourceDataMax = {};
            rows.forEach(row => {
                const sku = row["SKU"]?.toString().trim();
                const stock = Number(row["Availability"]);
                if (sku && !isNaN(stock)) {
                    if (!sourceDataMax[sku] || stock > sourceDataMax[sku]) sourceDataMax[sku] = stock;
                }
            });
            
            renderTable();
            checkReady();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    // Search Functionality
    document.getElementById('skuSearch').addEventListener('input', function() {
        renderTable(this.value.toLowerCase());
    });

    function renderTable(filter = "") {
        const tbody = document.querySelector("#previewTable tbody");
        tbody.innerHTML = "";
        
        const skus = Object.keys(sourceDataMax)
            .filter(sku => sku.toLowerCase().includes(filter))
            .sort();

        skus.forEach(sku => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${sku}</td><td class="stock-val">${sourceDataMax[sku]}</td>`;
            tbody.appendChild(tr);
        });

        document.getElementById('previewArea').style.display = "block";
        document.getElementById('resultCount').innerText = `Showing ${skus.length} unique SKUs`;
        document.getElementById('status').innerText = "Master Data Loaded.";
    }

    // 2. Load Target Template
    document.getElementById('targetFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        targetFileName = file.name;
        const reader = new FileReader();
        reader.onload = function(event) {
            targetFileArrayBuffer = event.target.result;
            checkReady();
        };
        reader.readAsArrayBuffer(file);
    });

    function checkReady() {
        if (Object.keys(sourceDataMax).length > 0 && targetFileArrayBuffer) {
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('status').innerText = "Ready to Export.";
        }
    }

    // 3. Export Logic (ExcelJS)
    document.getElementById('exportBtn').addEventListener('click', async function() {
        document.getElementById('status').innerText = "Processing Excel Styles...";
        
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(targetFileArrayBuffer);
        const worksheet = workbook.getWorksheet(1);

        let skuCol = -1, availCol = -1;

        worksheet.eachRow({ includeEmpty: false }, (row, rowNumber) => {
            if (skuCol === -1) {
                row.eachCell((cell, colNum) => {
                    const v = cell.value ? cell.value.toString().trim().toUpperCase() : "";
                    if (v === "SKU") skuCol = colNum;
                    if (v === "AVAILABILITY") availCol = colNum;
                });
            } else {
                const sku = row.getCell(skuCol).value ? row.getCell(skuCol).value.toString().trim() : null;
                const realMax = sourceDataMax[sku];

                if (sku && realMax !== undefined) {
                    const availCell = row.getCell(availCol);
                    const realStockCell = row.getCell(availCol + 1);

                    let display = realMax;
                    let color = null;

                    // Rules application
                    if (realMax === 10) { display = 3; color = 'FFFFFF00'; }
                    else if (realMax === 9) { display = 2; color = 'FFFFFF00'; }
                    else if (realMax === 8) { display = 1; color = 'FFFFFF00'; }
                    else if (realMax <= 7) { display = 0; color = 'FFFF0000'; }

                    availCell.value = display;

                    if (color) {
                        realStockCell.value = realMax;
                        realStockCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: color } };
                        realStockCell.border = { top:{style:'thin'}, left:{style:'thin'}, bottom:{style:'thin'}, right:{style:'thin'} };
                    }
                }
            }
        });

        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), "Final_Update_" + targetFileName);
        document.getElementById('status').innerText = "Download Finished!";
    });
</script>

</body>
</html>